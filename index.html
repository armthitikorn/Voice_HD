<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบทดสอบการพูดและการบันทึกเสียง (Voice HD)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Styles --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0; /* ลบ padding ออกเพื่อให้ responsive ง่ายขึ้น */
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto; /* เพิ่ม margin บนล่าง */
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        h1 {
            color: #007bff;
            font-weight: 700;
        }
        h2 {
            color: #007bff;
            border-left: 4px solid #007bff;
            padding-left: 10px;
        }

        /* --- Input and Part Selection --- */
        .user-info, .part-selection {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #inputUserName {
            padding: 10px;
            max-width: 300px; /* จำกัดความยาวช่องชื่อ */
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .part-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .part-button {
            flex: 1; /* ทำให้ปุ่มยืดได้ */
            min-width: 120px;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #007bff;
            border-radius: 6px;
            background-color: #fff;
            color: #007bff;
            transition: background-color 0.3s, color 0.3s;
        }
        .part-button:hover, .part-button.active {
            background-color: #007bff;
            color: #fff;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        /* --- Exam Area Layout (Responsive) --- */
        #examArea {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2 ส่วนสำหรับคำถาม, 1 ส่วนสำหรับรายการ */
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            #examArea {
                grid-template-columns: 1fr; /* Stacked layout on mobile */
            }
            .container {
                margin: 10px;
                padding: 15px;
            }
        }
        
        /* --- Question Panel --- */
        .question-panel {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .question-content, .required-answer {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 1.1em; /* เพิ่มขนาดตัวอักษรหลัก */
        }
        .question-content {
            background-color: #e0f7fa; /* สีอ่อนสำหรับคำถาม */
            border-left: 5px solid #00bcd4;
        }
        .required-answer {
            background-color: #ffeccf;
            border-left: 5px solid #ff9800;
        }
        
        /* --- Controls & Status --- */
        .recording-controls {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        #recordingStatus {
            font-weight: 700;
            margin-top: 20px;
            font-size: 1.1em;
            color: #007bff;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 700;
            transition: opacity 0.2s, transform 0.2s;
            font-size: 1em;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-danger { background-color: #dc3545; }
        .btn-success { background-color: #28a745; }
        .btn-primary { background-color: #007bff; margin-top: 20px; width: 100%;} /* ปุ่มส่ง Part ให้เต็มความกว้าง */

        #playbackControls {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        #playbackAudio {
            flex-grow: 1;
            min-width: 200px;
        }
        #sendQuestionBtn {
            flex-shrink: 0;
            font-size: 1.1em;
        }

        /* --- Question List Panel --- */
        .question-list-panel {
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            max-height: 600px;
            overflow-y: auto;
        }
        .question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question-item:hover, .question-item.active {
            background-color: #e9f7ff;
            font-weight: 700;
            border-left: 3px solid #007bff;
        }
        .status-icon {
            font-size: 1.2em;
            margin-left: 5px;
        }
        
        /* --- Alerts and Loading --- */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
            font-weight: 700;
        }
        .alert.info { background-color: #e7f7ff; color: #0056b3; border: 1px solid #b8daff; }
        .alert.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            font-size: 1.8em;
            color: #007bff;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>แบบทดสอบการพูดและการบันทึกเสียง (Voice HD)</h1>
            <p>กรุณาทำแบบทดสอบให้ครบ 90 ข้อ (3 Part) โดยบันทึกเสียงทีละข้อ และกดส่งเมื่อตรวจสอบไฟล์เสียงแล้ว</p>
        </header>

        <div id="mainAlert" class="alert info"></div>

        <div class="user-info">
            <h2>1. ข้อมูลผู้เข้าสอบ</h2>
            <label for="inputUserName">ชื่อ-นามสกุล/รหัสพนักงาน:</label>
            <input type="text" id="inputUserName" onchange="saveUserName()" placeholder="กรุณากรอกชื่อ-นามสกุล/รหัสพนักงาน" required>
        </div>

        <div class="part-selection">
            <h2>2. เลือก Part ที่ต้องการทำแบบทดสอบ</h2>
            <div class="part-buttons">
                <button id="btnPart1" class="part-button" onclick="loadPart('part1')">Part 1 (30 ข้อ)</button>
                <button id="btnPart2" class="part-button" onclick="loadPart('part2')">Part 2 (30 ข้อ)</button>
                <button id="btnPart3" class="part-button" onclick="loadPart('part3')">Part 3 (30 ข้อ)</button>
            </div>
        </div>

        <div id="examArea" style="display: none;">
            <div class="question-panel">
                <h2 id="currentQuestionTitle">Part 1: คำถามข้อที่ 1</h2>
                
                <div class="question-content">
                    <p><strong>คำถาม:</strong> <span id="questionPrompt">...</span></p>
                </div>

                <div class="required-answer">
                    <p><strong>แนวทางคำตอบที่ต้องการ:</strong> <span id="requiredAnswer">...</span></p>
                </div>

                <p id="recordingStatus" style="font-weight: 700; margin-top: 20px;">สถานะ: ยังไม่ได้เริ่มบันทึกเสียง</p>

                <div class="recording-controls">
                    <button id="startRecBtn" class="btn btn-success" onclick="handleStartRecording()">เริ่มบันทึกเสียง</button>
                    <button id="stopRecBtn" class="btn btn-danger" onclick="handleStopRecording()" disabled>หยุดบันทึก</button>
                </div>

                <div id="playbackControls">
                    <audio id="playbackAudio" controls style="display: none;"></audio>
                    <button id="sendQuestionBtn" onclick="handleSingleSubmission()" class="btn btn-success" style="display: none;" disabled>
                        ส่งคำตอบข้อนี้ (บันทึกและส่ง)
                    </button>
                </div>

                <button id="submitBtn" onclick="submitExam()" class="btn btn-primary" disabled>
                    ส่งงาน Part (ส่งแล้ว 0/30 ข้อ)
                </button>
            </div>

            <div class="question-list-panel">
                <h3>รายการคำถาม</h3>
                <div id="questionList">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="loadingOverlay">
        <p>กำลังดำเนินการส่งข้อมูล... กรุณารอสักครู่</p>
    </div>

    <script type="module">

        // --- Supabase Imports & Config ---
        // **กรุณาตรวจสอบ URL และ Key ของ Supabase อีกครั้งก่อนใช้งานจริง**
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- Questions Data (90 ข้อ) ---
        const questions = {
            // Part 1: การแก้คำปฏิเสธต้นสาย (30 ข้อ)
    part1: [
        { id: "P1Q1", part: 1, q: "ไม่สนใจครับ/ค่ะ ต้องขอโทษด้วย ขอวางสายเลยนะครับ/คะ", a: "เข้าใจเลยค่ะ/ครับ ว่าอาจจะยังไม่สนใจในตอนนี้ แต่ที่โทรมาหาคุณลูกค้าวันนี้เป็นโครงการพิเศษที่ **ไม่ได้เป็นการขายตรง** ค่ะ/ครับ เป็นเพียงการ **มอบสิทธิประโยชน์** ที่ใช้เวลาอธิบายแค่ 1 นาทีเท่านั้น ถ้าไม่ตรงใจ คุณลูกค้าสามารถวางสายได้เลยค่ะ/ครับ" },
        { id: "P1Q2", part: 1, q: "ขอโทษนะคะ/ครับ มีประกันที่ครอบคลุมทุกอย่างที่ต้องการแล้วค่ะ/ครับ", a: "เยี่ยมเลยค่ะ/ครับ แสดงว่าเป็นคนที่วางแผนชีวิตได้ดีมาก ถ้าอย่างนั้นขออนุญาตสอบถามสั้นๆ ค่ะ/ครับ *แผนที่คุณลูกค้ามีอยู่มีเรื่องของ **ค่าห้องสูงสุด** ถึง [ระบุตัวเลขสูง] หรือยังคะ/ครับ?* เพราะโครงการใหม่นี้ **เน้นเฉพาะจุดที่แผนเดิมอาจจะยังไม่ครอบคลุม** ค่ะ/ครับ" },
        { id: "P1Q3", part: 1, q: "ขอบคุณที่โทรมาเสนอค่ะ/ครับ แต่ตอนนี้ไม่สะดวกพิจารณาเรื่องประกันเพิ่มค่ะ/ครับ", a: "เข้าใจค่ะ/ครับ แต่โครงการนี้ **ไม่ได้บังคับให้พิจารณาตอนนี้** ค่ะ/ครับ เพียงแต่ **สิทธิ์ในการจอง** แผนเบี้ยพิเศษนี้จะหมดเขตเร็วๆ นี้ ขออนุญาตให้ข้อมูลหลักการเพื่อให้คุณลูกค้า **มีทางเลือกสำรอง** ไว้ก่อนตัดสินใจค่ะ/ครับ" },
        { id: "P1Q4", part: 1, q: "รบกวนช่วยนำเบอร์นี้ออกจากรายชื่อผู้ติดต่อได้ไหมครับ/คะ ไม่สนใจจริงๆ", a: "ยินดีค่ะ/ครับ ก่อนจะนำออกขออนุญาตใช้เวลา 15 วินาที เพื่อให้คุณลูกค้าได้ **ปฏิเสธด้วยข้อมูลที่ครบถ้วน** นะคะ/ครับ หากปฏิเสธแล้ว ดิฉัน/ผมจะดำเนินการนำชื่อออกให้ **ถาวร** ค่ะ/ครับ" },
        { id: "P1Q5", part: 1, q: "ช่วงนี้การเงินตึงตัวมากค่ะ/ครับ ขอโทษด้วยนะคะ/ครับ", a: "เข้าใจเลยค่ะ/ครับ เศรษฐกิจแบบนี้ทุกคนต้องระมัดระวัง นั่นเป็นเหตุผลที่เราอยากแนะนำแผนนี้เลยค่ะ/ครับ เพราะเรามีแผนที่ **เริ่มต้นที่ [ระบุเบี้ยต่อวัน เช่น 15 บาท/วัน]** เท่านั้น เพื่อให้มั่นใจว่าเงินเก็บไม่หายไปกับเรื่องไม่คาดฝันค่ะ/ครับ" },
        { id: "P1Q6", part: 1, q: "ขอโทษครับ/ค่ะ ตอนนี้กำลังขับรถ/ติดประชุม/ทำงานอยู่ ไม่สะดวกรับสายเรื่องส่วนตัวครับ/ค่ะ", a: "ต้องขออภัยจริงๆ ค่ะ/ครับ ที่รบกวนเวลาสำคัญ ถ้าอย่างนั้นขออนุญาต **นัดหมายเวลาที่สะดวก** ในวันนี้ หรือพรุ่งนี้เลยได้ไหมคะ/ครับ? เป็น **เย็นนี้ [ระบุเวลา]** หรือ **พรุ่งนี้เช้า [ระบุเวลา]** ดีคะ/ครับ?" },
        { id: "P1Q7", part: 1, q: "มีคนดูแลเรื่องการเงินและการทำประกันให้เรียบร้อยแล้วค่ะ/ครับ", a: "ดีมากค่ะ/ครับ การมีที่ปรึกษาเป็นเรื่องที่ควรทำ ถ้าอย่างนั้น ขออนุญาตฝากข้อมูล **'สิทธิพิเศษที่ไม่สามารถหาได้จากที่ปรึกษาทั่วไป'** นี้ไว้ให้คุณลูกค้าส่งต่อให้พิจารณาได้ไหมคะ/ครับ?" },
        { id: "P1Q8", part: 1, q: "ไม่รับโทรศัพท์ที่ติดต่อมาขายสินค้าหรือบริการครับ/ค่ะ ขออนุญาตวางสายนะครับ/คะ", a: "เข้าใจค่ะ/ครับ และขอโทษที่รบกวนเวลา แต่ถ้าอย่างนั้นขออนุญาตให้ข้อมูลสั้นๆ แค่ 30 วินาทีในฐานะ **ที่ปรึกษา** นะคะ/ครับ เพื่อให้คุณลูกค้าทราบว่ามีสิทธิพิเศษนี้อยู่ ถ้าไม่ตรงใจเราจะไม่ติดต่อกลับไปอีกค่ะ/ครับ" },
        { id: "P1Q9", part: 1, q: "ไม่ใช่นโยบายส่วนตัวที่จะซื้อประกันผ่านทางโทรศัพท์ครับ/ค่ะ", a: "ขอบคุณที่แจ้งนโยบายส่วนตัวค่ะ/ครับ ดิฉัน/ผมไม่ได้ขอให้คุณลูกค้าซื้อผ่านโทรศัพท์ค่ะ/ครับ เพียงแต่ **ใช้โทรศัพท์ในการแจ้งข้อมูล** และ **ยืนยันสิทธิ์** เท่านั้น การอนุมัติทั้งหมดจะถูกส่งไปให้คุณลูกค้า **พิจารณาอย่างละเอียด** ที่บ้านก่อนค่ะ/ครับ" },
        { id: "P1Q10", part: 1, q: "ผม/ดิฉันติดบัญชีดำเรื่องการเงินอยู่ครับ/ค่ะ คงทำไม่ได้", a: "เข้าใจถึงสถานการณ์ค่ะ/ครับ แต่โครงการของเรา **ไม่ได้มีการตรวจสอบเครดิตบูโร** ค่ะ/ครับ หากคุณลูกค้ามีอายุและสุขภาพอยู่ในเกณฑ์ก็สามารถทำได้เลยค่ะ/ครับ ขออนุญาตสอบถามเพียง 2 คำถามเกี่ยวกับอายุและสุขภาพได้ไหมคะ/ครับ?" },
        { id: "P1Q11", part: 1, q: "ขอโทษครับ/ค่ะ มีข้อจำกัดด้านสุขภาพ/อายุ ที่ไม่สามารถทำประกันเพิ่มได้แล้วค่ะ/ครับ", a: "เข้าใจเลยค่ะ/ครับ ทางเราก็มีโครงการที่ออกแบบมาเพื่อ **ผู้สูงวัย** หรือ **ผู้ที่มีประวัติสุขภาพ** โดยเฉพาะค่ะ/ครับ เช่น แผนที่ **ไม่ต้องตรวจสุขภาพ** ขออนุญาตสอบถามอายุและประวัติโดยย่อเพื่อดูว่าคุณลูกค้าเข้าเกณฑ์ไหมคะ/ครับ?" },
        { id: "P1Q12", part: 1, q: "รบกวนวางสายเลยนะคะ/ครับ ขอบคุณค่ะ/ครับ", a: "ได้ค่ะ/ครับ แต่ก่อนวางสาย ขออนุญาตยืนยันกับคุณลูกค้าหน่อยนะคะ/ครับว่าคุณลูกค้า **ได้ทราบข้อมูลสิทธิพิเศษ** ที่ช่วยให้คุณลูกค้า [ระบุประโยชน์หลัก] แล้วจริงๆ ถ้าทราบแล้ว ดิฉัน/ผมจะไม่รบกวนแล้วค่ะ/ครับ" },
        { id: "P1Q13", part: 1, q: "ไม่ว่างเลยครับ/ค่ะ พูดได้คำเดียวว่า *ไม่สนใจ* นะครับ/คะ", a: "เข้าใจว่าไม่สนใจค่ะ/ครับ เพียงแต่โครงการนี้เปิดให้สิทธิ์เฉพาะลูกค้าคนพิเศษตามข้อมูลที่เราได้รับมาเท่านั้นค่ะ/ครับ ขอเวลาสั้นๆ แค่ 20 วินาที เพื่อให้คุณลูกค้า **ไม่พลาดสิทธิ์** ที่ควรได้รับนะคะ/ครับ" },
        { id: "P1Q14", part: 1, q: "เงินเก็บไม่พอทำประกันครับ/ค่ะ", a: "เข้าใจค่ะ/ครับ ดิฉัน/ผมไม่ได้แนะนำให้คุณลูกค้าใช้เงินเก็บค่ะ/ครับ แต่แนะนำให้ **กันเงินส่วนเล็กน้อย** จากรายได้ประจำ เพื่อเปลี่ยนเป็นความมั่นคงที่สูงถึงหลักล้านค่ะ/ครับ (เช่น เงินค่ากาแฟต่อวัน) คุณลูกค้าคิดว่าถ้าเป็นจำนวนนี้พอจะแบ่งมาได้ไหมคะ/ครับ?" },
        { id: "P1Q15", part: 1, q: "รบกวนโทรกลับมาใหม่...วันมะรืนตอนตี 3 นะคะ/ครับ", a: "ขอบคุณที่ให้โอกาสค่ะ/ครับ แต่เกรงว่า **ระบบจะไม่สามารถโทรออกในช่วงเวลานั้นได้** ค่ะ/ครับ ถ้าอย่างนั้นขออนุญาตหาเวลาที่สะดวกที่สุด **ภายในพรุ่งนี้** ได้ไหมคะ/ครับ? เพราะ **โครงการนี้มีจำกัด** ค่ะ/ครับ" },
        { id: "P1Q16", part: 1, q: "ไม่เป็นไรค่ะ/ครับ ไม่ต้องอธิบายให้ฟัง เสียเวลาทั้งคู่", a: "ขอบคุณที่ตรงไปตรงมาค่ะ/ครับ นั่นหมายความว่าคุณลูกค้าอาจจะยังไม่ทราบ **ความแตกต่าง** ของโครงการที่เรากำลังนำเสนอ ที่ถูกออกแบบมาให้ **คุ้มค่ากว่า/เบี้ยถูกกว่า** แผนเดิมค่ะ/ครับ ขอเวลาเพียง 1 นาทีเพื่อเปรียบเทียบข้อดีนะคะ/ครับ" },
        { id: "P1Q17", part: 1, q: "มีกรมธรรม์ที่ซื้อไว้กับบริษัทคุณ/บริษัทอื่น เพียงพอต่อความต้องการแล้วค่ะ/ครับ", a: "เราทราบว่าคุณลูกค้ามีกรมธรรม์อยู่แล้ว แต่โครงการที่เรานำเสนอนี้เป็น **'กรมธรรม์ฉบับที่ 2'** ที่เน้นเรื่อง [ระบุ: เบี้ยถูกลง/วงเงินสูงขึ้น] **โดยเฉพาะ** ค่ะ/ครับ เพื่อให้คุณลูกค้า **ไม่ต้องปรับแผนเดิม** ที่มีอยู่เลย" },
        { id: "P1Q18", part: 1, q: "ขอโทษนะคะ/ครับ ไม่ได้รับสายเรื่องส่วนตัวในเวลางานค่ะ/ครับ", a: "เข้าใจค่ะ/ครับ ถ้าอย่างนั้นนอกเวลางานที่สะดวกที่สุดคือช่วงไหนดีคะ/ครับ ดิฉัน/ผมจะโทรกลับไป **ตามเวลานัดหมาย** เพื่อให้คุณลูกค้ามั่นใจว่าเราให้ความสำคัญกับเวลาส่วนตัวของคุณลูกค้าค่ะ/ครับ" },
        { id: "P1Q19", part: 1, q: "ผม/ดิฉันได้แจ้งไปหลายครั้งแล้วว่าไม่สนใจ รบกวนเคารพการตัดสินใจด้วยนะครับ/คะ", a: "ต้องขออภัยแทนเพื่อนร่วมงานที่รบกวนซ้ำซ้อนด้วยนะคะ/ครับ แต่ที่ดิฉัน/ผมโทรมาครั้งนี้ เพราะมีข้อมูล *อัพเดตสิทธิพิเศษ* ที่เป็น **ข้อเสนอสุดท้าย** ก่อนปิดโครงการจริงๆ ค่ะ/ครับ ขออนุญาตใช้โอกาสนี้ให้ข้อมูลครั้งเดียวและเป็นครั้งสุดท้ายนะคะ/ครับ" },
        { id: "P1Q20", part: 1, q: "ไม่มีเงินครับ/ค่ะ", a: "เข้าใจเลยค่ะ/ครับ ถ้าอย่างนั้นยิ่งต้องมีแผนนี้เลยค่ะ/ครับ เพราะ **คนที่ 'ไม่มีเงิน' ยิ่งมีความเสี่ยงสูง** หากเกิดเหตุไม่คาดฝัน แผนของเราจะช่วย **ปกป้องเงินเก็บที่มีอยู่** ไม่ให้ต้องนำมาใช้กับเรื่องฉุกเฉินค่ะ/ครับ" },
        { id: "P1Q21", part: 1, q: "กำลังทานข้าว/เข้าห้องน้ำอยู่ค่ะ/ครับ", a: "ขอโทษที่รบกวนช่วงเวลาพักผ่อนค่ะ/ครับ ขออนุญาตโทรกลับไปอีกครั้งหลังคุณลูกค้าทานข้าวเสร็จ หรืออีก **15 นาที** ได้ไหมคะ/ครับ? จะได้ไม่รบกวนสมาธิค่ะ/ครับ" },
        { id: "P1Q22", part: 1, q: "เราไม่สะดวกรับฟังการขายของผ่านโทรศัพท์จริงๆ ค่ะ/ครับ", a: "เข้าใจค่ะ/ครับ และเราก็ไม่ได้มีนโยบายขายของแบบยัดเยียด แต่ดิฉัน/ผมได้รับมอบหมายให้ **แจ้งสิทธิ์สำคัญ** ที่บริษัทมอบให้ค่ะ/ครับ ขอเวลาเพียง **1 นาที** เพื่อแจ้งสิทธิ์นี้โดยย่อ หากไม่ถูกใจจะได้ลบชื่อคุณลูกค้าออกจากระบบทันทีค่ะ/ครับ" },
        { id: "P1Q23", part: 1, q: "ตอนนี้งดรับภาระผูกพันระยะยาวทุกชนิดครับ/ค่ะ", a: "เข้าใจและเห็นด้วยค่ะ/ครับ ดังนั้น ดิฉัน/ผมขอเสนอทางเลือกที่เป็น **ระยะสั้นและยืดหยุ่นสูง** ค่ะ/ครับ เช่น แผนคุ้มครอง 1 ปี หรือแผนที่ **หยุดจ่ายได้** ในกรณีที่มีปัญหาการเงิน โดยที่ยังคงได้รับความคุ้มครองอยู่" },
        { id: "P1Q24", part: 1, q: "คุณพูดมาก็ดี แต่ผม/ดิฉันไม่สนใจครับ/ค่ะ ขอโทษนะคะ/ครับ", a: "เข้าใจที่คุณลูกค้าแจ้งมาค่ะ/ครับ แต่ถ้าเป็นเรื่องของการ **ประหยัด** หรือ **ผลประโยชน์ที่มากกว่าเดิม** คุณลูกค้าคิดว่าน่าสนใจไหมคะ/ครับ โครงการนี้จะเข้ามา **อุดช่องว่าง** ที่คุณลูกค้าอาจจะยังมองไม่เห็นในแผนเดิมค่ะ/ครับ" },
        { id: "P1Q25", part: 1, q: "ขอให้ข้อมูลสั้นๆ ว่า...ไม่สนใจค่ะ/ครับ", a: "เข้าใจค่ะ/ครับ ถ้าอย่างนั้น ขออนุญาตฝากข้อมูลสั้นๆ *ในฐานะผู้เชี่ยวชาญ* เพื่อให้คุณลูกค้ามั่นใจว่าได้ **ปฏิเสธในสิ่งที่ทราบดีแล้ว** นะคะ/ครับ แผนนี้เป็น [ระบุประเภทประกัน] ที่ [ระบุจุดเด่น 1 อย่าง] ค่ะ/ครับ" },
        { id: "P1Q26", part: 1, q: "ไม่ซื้อค่ะ/ครับ", a: "เข้าใจค่ะ/ครับ ดิฉัน/ผมไม่ได้โทรมาเพื่อให้คุณลูกค้า **ซื้อ** ทันทีค่ะ/ครับ แต่โทรมาเพื่อให้คุณลูกค้า **รับทราบทางเลือกที่ดีที่สุด** ในตลาดตอนนี้เท่านั้น ขออนุญาตให้ข้อมูล 30 วินาทีนะคะ/ครับ" },
        { id: "P1Q27", part: 1, q: "มีประกันชีวิต/สุขภาพ/ออมทรัพย์ ที่ทำไว้ล่วงหน้าเรียบร้อยแล้วครับ/ค่ะ", a: "เราทราบว่าคุณลูกค้ามีกรมธรรม์อยู่แล้ว แต่โครงการที่เรานำเสนอนี้เป็น **'กรมธรรม์ฉบับที่ 2'** ที่เน้นเรื่อง [ระบุ: เบี้ยถูกลง/วงเงินสูงขึ้น] **โดยเฉพาะ** ค่ะ/ครับ เพื่อให้คุณลูกค้า **ไม่ต้องปรับแผนเดิม** ที่มีอยู่เลย" },
        { id: "P1Q28", part: 1, q: "ขอโทษนะคะ/ครับ โทรผิดเวลามากเลยค่ะ/ครับ", a: "ต้องขออภัยจริงๆ ค่ะ/ครับ ถ้าอย่างนั้น **เวลาที่เหมาะสมที่สุด** ที่คุณลูกค้าสะดวกให้ดิฉัน/ผมโทรมาให้ข้อมูล **ภายในวันนี้** คือช่วงไหนดีคะ/ครับ?" },
        { id: "P1Q29", part: 1, q: "ไม่สนใจทำเรื่องประกันกับบริษัท...ครับ/ค่ะ", a: "เข้าใจค่ะ/ครับ ดิฉัน/ผมทราบดีว่าคุณลูกค้าอาจเคยมีประสบการณ์ที่ไม่ดีกับบริษัทอื่น แต่เราอยากให้คุณลูกค้า **พิจารณาจากตัวผลิตภัณฑ์** ที่มีความคุ้มค่ามากกว่าชื่อบริษัทค่ะ/ครับ แผนนี้เป็นแผนที่ **[ระบุจุดเด่น]** ซึ่ง *ไม่เกี่ยวข้องกับภาพลักษณ์ของบริษัทในอดีต* เลยค่ะ/ครับ" },
        { id: "P1Q30", part: 1, q: "สวัสดีครับ/ค่ะ ไม่สนใจประกันค่ะ/ครับ ขอวางสายนะคะ/ครับ", a: "สวัสดีค่ะ/ครับ เข้าใจเลยค่ะ/ครับ ดิฉัน/ผมทราบดีว่าคุณลูกค้าเป็นคนมีวินัยในการจัดการเรื่องนี้แล้ว แต่ที่โทรมานี้ไม่ใช่ประกันชีวิตแบบทั่วไปค่ะ/ครับ แต่เป็น [ระบุชื่อโครงการ/สิทธิพิเศษ] ที่ทางบริษัทมอบให้ **เฉพาะ** ลูกค้าคนสำคัญ ขอเวลา 30 วินาทีนะคะ/ครับ" }
    ],
            // Part 2: การตอบคำถามไขข้อกังวลใจของลูกค้า (30 ข้อ)
part2: [
    { id: "P2Q1", part: 2, q: "ถ้ามีโรคประจำตัวหรือเคยป่วยมาก่อน ประกันจะ **ไม่คุ้มครอง** ใช่ไหม?", a: "นี่เป็นคำถามที่ดีมากครับ/ค่ะ! สำหรับโรคที่เป็นมาก่อน (Pre-existing Condition) เรามีหลักเกณฑ์การพิจารณาครับ/ค่ะ **โดยทั่วไป** เราจะดูว่าคุณลูกค้าเป็นมานานแค่ไหน หากเป็นโรคเล็กน้อยที่รักษาหายแล้ว อาจจะคุ้มครองได้ทันที แต่ถ้าเป็นเรื้อรัง อาจมีข้อยกเว้นบางโรคหรือไม่คุ้มครองในช่วงแรก **ดิฉัน/ผมขออนุญาตสอบถามประวัติสั้นๆ เพื่อให้คำตอบที่ชัดเจนที่สุดครับ/ค่ะ**" },
    { id: "P2Q2", part: 2, q: "ถ้าต้องรักษาในโรงพยาบาลเอกชนชั้นนำ จะมีปัญหาเรื่อง **วงเงินไม่พอ** หรือไม่?", a: "หมดกังวลเรื่องนั้นได้เลยครับ/ค่ะ แผนที่เรานำเสนอคือ [ระบุชื่อแผน] ซึ่งออกแบบมาให้มี **วงเงินต่อครั้ง** ที่สูงมาก ครอบคลุมค่าใช้จ่ายส่วนใหญ่ของโรงพยาบาลชั้นนำได้สบาย ๆ และยังมีการ **อัปเกรดความคุ้มครอง** ให้สอดคล้องกับค่ารักษาพยาบาลที่เพิ่มขึ้นในอนาคตด้วยครับ/ค่ะ" },
    { id: "P2Q3", part: 2, q: "ขั้นตอนการเคลมยุ่งยากไหม? ต้อง **สำรองจ่าย** ก่อนหรือเปล่า?", a: "ขั้นตอนง่ายมากครับ/ค่ะ **เรามีระบบ Fax Claim/Direct Billing** เพียงแค่คุณลูกค้าแสดงบัตรประกันที่โรงพยาบาลในเครือข่าย ก็ไม่ต้องสำรองจ่ายเงินส่วนใหญ่เลยครับ/ค่ะ ยกเว้นกรณีที่เกินวงเงินของแผนเท่านั้น ส่วนการเคลมที่ต้องสำรองจ่ายก็ทำได้ผ่านแอปพลิเคชันอย่างรวดเร็วครับ/ค่ะ" },
    { id: "P2Q4", part: 2, q: "กรณีฉุกเฉินหรืออุบัติเหตุ สามารถใช้ประกันเข้า **โรงพยาบาลไหนก็ได้** ทั่วประเทศจริงไหม?", a: "จริงครับ/ค่ะ สำหรับกรณี **ฉุกเฉิน** หรือ **อุบัติเหตุ** คุณลูกค้าสามารถเข้ารับการรักษาในโรงพยาบาลที่ใกล้ที่สุดได้เลยครับ/ค่ะ ไม่ว่าจะเป็นโรงพยาบาลในเครือข่ายหรือไม่ก็ตาม โดยบริษัทจะพิจารณาการเคลมตามความจำเป็นทางการแพทย์ครับ/ค่ะ" },
    { id: "P2Q5", part: 2, q: "ถ้าหมอสั่งตรวจเพิ่มเติม เช่น MRI, CT Scan ประกันจะ **จ่ายค่าเครื่องมือพิเศษ** เหล่านี้ให้ไหม?", a: "แผนสุขภาพของเราเน้นการรักษาที่ทันสมัยครับ/ค่ะ **ค่าใช้จ่ายในการตรวจวินิจฉัยพิเศษ** เช่น MRI, CT Scan, PET Scan จะถูกครอบคลุมภายใต้วงเงินค่ารักษาพยาบาลผู้ป่วยใน (IPD) ตามความจำเป็นทางการแพทย์ที่แพทย์สั่งเลยครับ/ค่ะ" },
    { id: "P2Q6", part: 2, q: "ประกันจะครอบคลุม **ค่ารักษาพยาบาลทางเลือก** (เช่น ฝังเข็ม กายภาพบำบัด) หรือไม่?", a: "โดยปกติแล้ว **การรักษาทางเลือกจะไม่ถูกรวมอยู่ในการคุ้มครองหลัก** ครับ/ค่ะ แต่ถ้าเป็น **กายภาพบำบัด** ที่แพทย์สั่งหลังการบาดเจ็บหรือผ่าตัด และอยู่ในช่วงเวลาที่กำหนด ก็จะอยู่ในความคุ้มครองครับ/ค่ะ หากต้องการความคุ้มครองทางเลือกเพิ่มเติม เรามีสัญญาเพิ่มเติมให้เลือกซื้อได้ครับ/ค่ะ" },
    { id: "P2Q7", part: 2, q: "ถ้าต้องผ่าตัด **โรคที่เป็นมาก่อน** การทำประกัน (Pre-existing Condition) จะเคลมได้ไหม?", a: "หากโรคที่เป็นมาก่อน **ถูกระบุเป็นข้อยกเว้นไว้ในกรมธรรม์** ตั้งแต่แรก จะไม่สามารถเคลมได้ครับ/ค่ะ แต่ถ้าโรคดังกล่าว **ได้รับการอนุมัติให้คุ้มครอง** ตั้งแต่ทำสัญญา หรือไม่ได้ระบุเป็นข้อยกเว้นและพ้นช่วงระยะเวลารอคอยไปแล้ว ก็สามารถเคลมได้ตามเงื่อนไขครับ/ค่ะ" },
    { id: "P2Q8", part: 2, q: "มี **จำนวนวันพักรักษาตัวสูงสุด** ที่จำกัดการเคลมต่อปีหรือไม่?", a: "ความคุ้มครองของเราเน้นที่ **วงเงินรวมต่อปี** ครับ/ค่ะ ไม่ได้จำกัดจำนวนวันพักรักษาตัวเหมือนแผนสมัยก่อน ซึ่งหมายความว่าคุณลูกค้าสามารถเข้าพักได้ตามความจำเป็นทางการแพทย์จนกว่าวงเงินต่อปีจะเต็มครับ/ค่ะ" },
    { id: "P2Q9", part: 2, q: "ถ้าบริษัทประกันปฏิเสธการเคลม ฉันสามารถ **อุทธรณ์** หรือเรียกร้องได้อย่างไร?", a: "บริษัทเรามีขั้นตอนการอุทธรณ์ที่ชัดเจนและยุติธรรมครับ/ค่ะ คุณลูกค้าสามารถ **ยื่นเอกสารทางการแพทย์เพิ่มเติม** เพื่อให้ทีมแพทย์ผู้เชี่ยวชาญของเราพิจารณาอีกครั้ง หรือสามารถร้องเรียนผ่านหน่วยงานกำกับดูแล เช่น คปภ. ได้เลยครับ/ค่ะ" },
    { id: "P2Q10", part: 2, q: "ถ้าฉันไปรักษาที่ต่างประเทศ ประกันสุขภาพนี้ **ยังให้ความคุ้มครอง** อยู่หรือไม่?", a: "แผนสุขภาพ [ระบุชื่อแผน] นี้มี **ความคุ้มครองทั่วโลก** ครับ/ค่ะ (หากเป็นแผน Global) หรือหากเป็นแผนในประเทศ จะครอบคลุมในกรณีฉุกเฉินที่เกิดขึ้นระหว่างการเดินทางในต่างประเทศครับ/ค่ะ แต่มีวงเงินและเงื่อนไขที่แตกต่างกัน **ขออนุญาตยืนยันขอบเขตของแผนนี้อีกครั้งครับ/ค่ะ**" },
    { id: "P2Q11", part: 2, q: "เบี้ยประกันจะ **เพิ่มขึ้นเยอะมาก** เมื่ออายุมากขึ้นใช่ไหม?", a: "เบี้ยประกันสุขภาพจะเพิ่มขึ้นตามอายุเป็นปกติครับ/ค่ะ เนื่องจากความเสี่ยงสุขภาพที่สูงขึ้น **แต่เรามีการจัดการความเสี่ยงที่ดี** ทำให้เบี้ยปรับขึ้นอย่างมีเหตุผลและไม่ก้าวกระโดดจนเกินไป นอกจากนี้ยังสามารถเลือกแผนที่มี **เบี้ยคงที่ยาวนาน** ได้ด้วยครับ/ค่ะ" },
    { id: "P2Q12", part: 2, q: "ปีหน้าบริษัทจะ **ปรับเบี้ยขึ้น** โดยไม่มีการแจ้งล่วงหน้าได้ไหม?", a: "บริษัทไม่สามารถปรับเบี้ยขึ้นโดยพลการได้ครับ/ค่ะ การปรับเบี้ยเป็นไปตาม **หลักเกณฑ์ที่ คปภ. กำหนด** และเป็นไปตามสถิติความเสี่ยงของกลุ่มลูกค้าทั้งหมด ไม่ใช่แค่รายบุคคลครับ/ค่ะ หากมีการปรับขึ้น จะมีการแจ้งล่วงหน้าตามกฎหมายครับ/ค่ะ" },
    { id: "P2Q13", part: 2, q: "ฉันสามารถ **ปรับลดความคุ้มครอง** ลงได้หรือไม่ หากงบประมาณมีปัญหา?", a: "สามารถทำได้ครับ/ค่ะ หากคุณลูกค้าประสบปัญหาด้านงบประมาณ เราสามารถช่วย **ลดระดับแผน** หรือ **เพิ่มความรับผิดชอบส่วนแรก (Deductible)** เพื่อให้เบี้ยถูกลงได้ครับ/ค่ะ บริษัทมีความยืดหยุ่นเพื่อให้คุณลูกค้ายังคงมีความคุ้มครองไว้ครับ/ค่ะ" },
    { id: "P2Q14", part: 2, q: "มี **ค่าใช้จ่ายอื่น ๆ แฝง** นอกเหนือจากเบี้ยประกันที่จ่ายรายเดือน/รายปีไหม?", a: "ไม่มีครับ/ค่ะ คุณลูกค้าจะจ่ายเพียงแค่ **เบี้ยประกัน** ตามที่ระบุในตารางเท่านั้นครับ/ค่ะ **ยกเว้น** กรณีที่ต้องสำรองจ่ายเมื่อเกินวงเงิน หรือมีค่าใช้จ่ายส่วนที่ไม่ได้อยู่ในความคุ้มครองของแผนครับ/ค่ะ" },
    { id: "P2Q15", part: 2, q: "ถ้าฉันไม่เคยเคลมเลย จะมี **ส่วนลด** หรือได้เงินคืนบ้างไหม?", a: "แม้ว่าประกันสุขภาพหลักจะไม่ใช่การออมทรัพย์ แต่เรามีโครงการพิเศษ เช่น **ส่วนลดเบี้ยประกันปีถัดไป** (No-Claim Bonus) หรือแผนสุขภาพควบการลงทุน (Unit Linked) ที่มีโอกาสได้รับผลตอบแทนหากไม่เคลมครับ/ค่ะ" },
    { id: "P2Q16", part: 2, q: "สัญญาเป็นแบบ **ต่ออายุรายปี** ใช่ไหม? แล้วถ้าไม่ต่ออายุจะเกิดอะไรขึ้น?", a: "ใช่ครับ/ค่ะ สุขภาพเป็นแบบต่ออายุรายปี **ถ้าคุณลูกค้าไม่ต่ออายุ** กรมธรรม์ก็จะสิ้นสุดความคุ้มครองทันที และถ้าอยากทำใหม่ในภายหลัง อาจต้องแถลงสุขภาพใหม่ ซึ่งอาจมีปัญหาหากสุขภาพเปลี่ยนไปครับ/ค่ะ **จึงแนะนำให้คงความคุ้มครองไว้ครับ/ค่ะ**" },
    { id: "P2Q17", part: 2, q: "มีระยะเวลา **รอคอย (Waiting Period)** สำหรับโรคอะไรบ้าง? และนานแค่ไหน?", a: "มีครับ/ค่ะ โดยหลักจะมีระยะรอคอย 30 วันสำหรับโรคทั่วไป และ 120 วันสำหรับโรคร้ายแรงบางชนิดตามที่ระบุในสัญญา **เพื่อให้คุณลูกค้าได้ประโยชน์สูงสุด เราควรเริ่มต้นความคุ้มครองให้เร็วที่สุดครับ/ค่ะ**" },
    { id: "P2Q18", part: 2, q: "บริษัทจะ **ยกเลิก** กรมธรรม์ของฉันได้ไหม ถ้าฉันเคลมบ่อยเกินไป?", a: "ตามกฎหมาย บริษัท **ไม่สามารถยกเลิก** กรมธรรม์สุขภาพได้หากคุณลูกค้ามีการเคลมบ่อยครับ/ค่ะ ตราบใดที่คุณลูกค้าชำระเบี้ยตามกำหนดและไม่ได้มีการแถลงสุขภาพเป็นเท็จตั้งแต่แรก **คุณลูกค้ามั่นใจได้ว่าความคุ้มครองจะอยู่กับคุณลูกค้าครับ/ค่ะ**" },
    { id: "P2Q19", part: 2, q: "ความคุ้มครองสุขภาพนี้ **คุ้มครองไปถึงอายุเท่าไหร่** หรือตลอดชีวิตหรือไม่?", a: "แผนนี้ให้ความคุ้มครองยาวนานถึง **อายุ [ระบุอายุสูงสุดของแผน เช่น 80 ปี หรือ ตลอดชีวิต 99 ปี]** ครับ/ค่ะ ซึ่งถือเป็นการวางแผนสุขภาพในระยะยาวที่มั่นคงมากครับ/ค่ะ" },
    { id: "P2Q20", part: 2, q: "**ความเสี่ยง** ที่สำคัญที่สุดที่ไม่ได้อยู่ในความคุ้มครองคืออะไร?", a: "โดยทั่วไปคือ **ความเสี่ยงจากการฆ่าตัวตาย**, **การรักษาที่ไม่จำเป็นทางการแพทย์**, **การรักษาภาวะมีบุตรยาก**, และ **โรคที่เกิดจากการใช้ยาเสพติด** ครับ/ค่ะ แต่โดยรวมแล้วครอบคลุมโรคและอุบัติเหตุทั่วไปเกือบทั้งหมดครับ/ค่ะ" },
    { id: "P2Q21", part: 2, q: "**ความมั่นคงทางการเงิน** ของบริษัทดีพอที่จะจ่ายค่ารักษาพยาบาลก้อนใหญ่ ๆ ได้จริงไหม?", a: "บริษัทของเรา [ระบุชื่อบริษัท] มี **อันดับความน่าเชื่อถือ [ระบุ A-Rating]** และมีอัตราส่วนเงินกองทุนที่สูงกว่าเกณฑ์ที่ คปภ. กำหนดมากครับ/ค่ะ **คุณลูกค้ามั่นใจได้ 100%** ว่าเรามีความพร้อมและศักยภาพในการจ่ายสินไหมทุกกรณีครับ/ค่ะ" },
    { id: "P2Q22", part: 2, q: "**บริการให้คำปรึกษาทางการแพทย์** (Telemedicine) มีจริงและใช้งานได้ตลอด 24 ชั่วโมงไหม?", a: "มีจริงครับ/ค่ะ เรามี **บริการ Telemedicine 24 ชั่วโมง** ให้คำปรึกษาเบื้องต้นกับแพทย์ผู้เชี่ยวชาญ ซึ่งช่วยให้คุณลูกค้าตัดสินใจเข้ารับการรักษาได้อย่างรวดเร็วและถูกต้องโดยไม่ต้องออกจากบ้านเลยครับ/ค่ะ" },
    { id: "P2Q23", part: 2, q: "ถ้าฉันเปลี่ยนเบอร์โทรศัพท์หรือที่อยู่ จะ **ติดต่อบริษัท** เพื่อแจ้งการเปลี่ยนแปลงได้อย่างไร?", a: "คุณลูกค้าสามารถแจ้งได้หลายช่องทางครับ/ค่ะ ทั้ง **ผ่านดิฉัน/ผมที่เป็นตัวแทน**, ผ่าน **ศูนย์บริการลูกค้า 24 ชั่วโมง**, หรือผ่าน **แอปพลิเคชัน/เว็บไซต์** ของบริษัทได้เลยครับ/ค่ะ สะดวกสบายและรวดเร็วครับ/ค่ะ" },
    { id: "P2Q24", part: 2, q: "มี **แอปพลิเคชัน** หรือช่องทางออนไลน์ให้ตรวจสอบสถานะการเคลมและกรมธรรม์หรือไม่?", a: "มีครับ/ค่ะ บริษัทเรามี **แอปพลิเคชันมือถือ [ระบุชื่อ App]** ที่ทันสมัยมากครับ/ค่ะ คุณลูกค้าสามารถตรวจสอบรายละเอียดกรมธรรม์, สถานะการเคลม, และค้นหาโรงพยาบาลในเครือข่ายได้ตลอด 24 ชั่วโมงเลยครับ/ค่ะ" },
    { id: "P2Q25", part: 2, q: "หากเกิดปัญหา ฉันสามารถ **พูดคุยกับพนักงานที่เป็นคนจริง ๆ** ได้ไหม ไม่ใช่ระบบอัตโนมัติ?", a: "แน่นอนครับ/ค่ะ! ถึงแม้เราจะมีระบบอัตโนมัติเพื่อความรวดเร็ว แต่เรามี **เจ้าหน้าที่บริการลูกค้า** ที่พร้อมให้บริการและตอบคำถามคุณลูกค้าได้ตลอด 24 ชั่วโมงครับ/ค่ะ เพียงแค่กด [ระบุเบอร์ต่อ/ทางเลือก] ก็ได้คุยกับคนจริง ๆ เลยครับ/ค่ะ" },
    { id: "P2Q26", part: 2, q: "ประกันสุขภาพของบริษัทคุณ **ดีกว่าคู่แข่ง** ในตลาดอย่างไรบ้าง? (จุดเด่น 3 ข้อ)", a: "จุดเด่น 3 ข้อของเราคือ 1. **วงเงินที่สูงและยืดหยุ่น** (ปรับได้ตามค่าห้อง) 2. **ความรวดเร็วในการเคลม** (Fax Claim ภายใน 30 นาที) 3. **บริการเสริมพิเศษ** เช่น บริการรถพยาบาลฉุกเฉิน หรือ Telemedicine ครับ/ค่ะ" },
    { id: "P2Q27", part: 2, q: "**รีวิวจากลูกค้าที่เคยเคลม** จริง ๆ เป็นอย่างไรบ้าง? มีปัญหาอะไรที่พบบ่อยไหม?", a: "ลูกค้าส่วนใหญ่พึงพอใจมากครับ/ค่ะ โดยเฉพาะเรื่อง **ความรวดเร็วในการเคลมแบบไม่ต้องสำรองจ่าย** ปัญหาที่พบบ่อยที่สุดคือการไม่เข้าใจเงื่อนไขของ **ข้อยกเว้นบางโรค** ซึ่งเป็นสิ่งที่ดิฉัน/ผมจะช่วยตรวจสอบและอธิบายให้คุณลูกค้าเข้าใจชัดเจนก่อนตัดสินใจครับ/ค่ะ" },
    { id: "P2Q28", part: 2, q: "ถ้าฉันทำไปแล้วและ **เปลี่ยนใจ** ภายในกี่วันถึงจะได้รับเงินคืนเต็มจำนวน?", a: "คุณลูกค้ามีสิทธิ์ **ยกเลิกกรมธรรม์** ภายใน **15 วัน** นับจากวันที่ได้รับเล่มกรมธรรม์ (Free Look Period) และจะได้รับเบี้ยประกันคืนเต็มจำนวนครับ/ค่ะ" },
    { id: "P2Q29", part: 2, q: "มี **ค่าธรรมเนียม** หรือ **ค่าใช้จ่ายในการยกเลิก** สัญญาหรือไม่?", a: "หากยกเลิกภายใน 15 วัน (Free Look Period) จะไม่มีค่าธรรมเนียมใด ๆ ครับ/ค่ะ หากยกเลิกหลังจากนั้น ค่าธรรมเนียมจะเป็นไปตามตารางมูลค่าเวนคืนกรมธรรม์ ซึ่งเป็นไปตามที่กฎหมายกำหนดครับ/ค่ะ" },
    { id: "P2Q30", part: 2, q: "ฉันควร **เปรียบเทียบแผนนี้กับแผนอื่น ๆ** ของบริษัทคุณด้วยตัวเองก่อนไหม?", a: "แน่นอนครับ/ค่ะ การเปรียบเทียบเป็นสิ่งที่ดี แต่เพื่อประหยัดเวลา **ดิฉัน/ผมได้เลือกแผน [ระบุชื่อแผน] ที่เหมาะสมกับข้อมูลที่คุณลูกค้าแจ้งมาที่สุดแล้ว** แต่ถ้าคุณลูกค้ามีงบประมาณหรือความต้องการอื่น ๆ เพิ่มเติม ดิฉัน/ผมยินดีเปรียบเทียบแผนที่เหลือให้ดูได้ภายใน 5 นาทีครับ/ค่ะ" }
],
            // Part 3: การแก้ข้อโต้แย้งหรือการโน้มน้าวระหว่างปิดการขาย (30 ข้อ)
part3: [
    { id: "P3Q1", part: 3, q: "ขอคิดดูก่อนนะ เดี๋ยวถ้าสนใจจะโทรกลับไปเอง", a: "เข้าใจเลยครับ/ค่ะ การคิดทบทวนเป็นสิ่งที่ดี แต่การตัดสินใจวันนี้จะช่วย **ล็อกสิทธิ์ [ระบุ: เบี้ยราคาเดิม/ความคุ้มครองพิเศษ]** ให้คุณลูกค้าได้ทันทีครับ/ค่ะ ขออนุญาตสรุปข้อดีหลักๆ 3 ข้อสุดท้ายให้คุณลูกค้าทบทวนได้ง่ายขึ้นนะครับ/คะ?" },
    { id: "P3Q2", part: 3, q: "ขอปรึกษาคนในครอบครัว/หัวหน้า/สามี/ภรรยาก่อน", a: "นั่นเป็นเรื่องสำคัญที่ควรทำครับ/ค่ะ เพื่อให้ปรึกษาได้อย่างมีประสิทธิภาพ ดิฉัน/ผมขอสรุป **จุดคุ้มครองหลัก 3 ประเด็น** ที่สำคัญที่สุดเพื่อที่คุณลูกค้าจะสามารถนำไปนำเสนอได้อย่างถูกต้องและครบถ้วนนะครับ/คะ" },
    { id: "P3Q3", part: 3, q: "ตอนนี้ยังไม่พร้อมจ่าย (ขอเลื่อนไปจ่ายเดือนหน้า)", a: "ถ้าเช่นนั้น เรามีทางออกที่ยืดหยุ่นให้ครับ/ค่ะ คือการเลือก **ผ่อนชำระรายเดือน** ซึ่งเริ่มต้นเพียง [ระบุจำนวนเงินต่อวัน/เดือน] หรือให้ดิฉัน/ผม **จองสิทธิ์ให้วันนี้** และกำหนดวันชำระเงินที่สะดวกที่สุดภายใน 7 วันได้ไหมครับ/ค่ะ? (เพื่อล็อกสิทธิ์)" },
    { id: "P3Q4", part: 3, q: "ขอให้ส่งเอกสารทั้งหมดมาทางอีเมลก่อน แล้วจะอ่านดู", a: "ดิฉัน/ผมยินดีส่งให้ทันทีครับ/ค่ะ แต่เอกสารมีรายละเอียดมาก การอธิบายสั้นๆ เพียง 5 นาที จะช่วยให้คุณลูกค้าทราบว่า **ส่วนไหนสำคัญที่สุดที่ควรอ่าน** ก่อนการตัดสินใจนะครับ/คะ" },
    { id: "P3Q5", part: 3, q: "ขอเวลาเปรียบเทียบกับบริษัทอื่น ๆ ก่อน", a: "ถ้าเช่นนั้น ขออนุญาตช่วยคุณลูกค้าประหยัดเวลาครับ/ค่ะ แผนของเรามีจุดเด่นเรื่อง **[ระบุจุดเด่น เช่น วงเงินสูงสุด/เบี้ยคงที่]** ที่คู่แข่งส่วนใหญ่ไม่มี **มีอะไรที่บริษัทอื่นเสนอแล้วคุณลูกค้ายังไม่แน่ใจบ้างไหมครับ/คะ?**" },
    { id: "P3Q6", part: 3, q: "พี่/หนูมีนัดหมายอื่นต่อ ต้องขอวางสายก่อนนะ", a: "เข้าใจครับ/ค่ะ ขอโทษที่รบกวนเวลา ดิฉัน/ผมขอใช้เวลา **15 วินาทีสุดท้าย** เพื่อยืนยันว่า **คุณลูกค้าได้สิทธิ์ [ระบุสิทธิ์]** นี้ก่อนที่จะพลาดไปนะครับ/คะ" },
    { id: "P3Q7", part: 3, q: "เดี๋ยวฉันจะศึกษาข้อมูลบริษัทและผลิตภัณฑ์ของคุณจากอินเทอร์เน็ตก่อน", a: "เป็นความคิดที่ดีมากครับ/ค่ะ แต่ข้อมูลบนอินเทอร์เน็ตอาจจะเก่าหรือเป็นแผนอื่น **ดิฉัน/ผมมีข้อมูลแผนเฉพาะกิจวันนี้** ที่ยังไม่เผยแพร่ต่อสาธารณะ **คุณลูกค้ามั่นใจได้ว่าข้อมูลจากดิฉัน/ผมคือข้อมูลที่ถูกต้องที่สุดครับ/ค่ะ**" },
    { id: "P3Q8", part: 3, q: "ฉันเป็นคนตัดสินใจช้า ขอเวลาทบทวนเรื่องนี้สัก 2-3 วัน", a: "เข้าใจครับ/ค่ะ แต่ 2-3 วันนี้อาจทำให้คุณลูกค้าต้อง **เริ่มต้นระยะรอคอย (Waiting Period) ช้าลง** ไปอีกนะครับ/คะ หากคุณลูกค้าตัดสินใจ **จองสิทธิ์วันนี้** ความคุ้มครองจะเริ่มนับเร็วขึ้นครับ/ค่ะ" },
    { id: "P3Q9", part: 3, q: "ตอนนี้ฉันกำลังยุ่งอยู่กับโครงการอื่น/เรื่องส่วนตัวอื่น ๆ", a: "ขอแสดงความยินดีกับโครงการนั้นด้วยครับ/ค่ะ **ดิฉัน/ผมจะใช้เวลาแค่ 5 นาที** ในการบันทึกข้อมูลสำคัญเพื่อ **สำรองสิทธิ์** นี้ไว้ให้คุณลูกค้า โดยที่คุณลูกค้าสามารถกลับไปดำเนินการเรื่องสำคัญต่อได้เลยครับ/ค่ะ" },
    { id: "P3Q10", part: 3, q: "ฉันจะบอกพี่/น้องชายที่เป็นตัวแทนประกันให้ทำเรื่องให้เอง", a: "ยินดีด้วยครับ/ค่ะที่คนในครอบครัวเป็นตัวแทน แต่แผนพิเศษนี้อาจมี **สิทธิประโยชน์และเบี้ยประกัน** ที่ **ต่างจากแผนปกติ** ที่ตัวแทนทั่วไปเสนอได้ครับ/ค่ะ ขออนุญาตให้ข้อมูลส่วนนี้ไปเปรียบเทียบกับน้องชายได้ไหมครับ/ค่ะ?" },
    { id: "P3Q11", part: 3, q: "ราคาแพงไปหน่อยนะ มีแผนที่ถูกกว่านี้ไหม?", a: "หากราคาเป็นข้อกังวล ดิฉัน/ผมมีแผนที่สามารถ **ลดเบี้ยลงได้ [ระบุ %]** โดยการเพิ่ม **ความรับผิดชอบส่วนแรก (Deductible)** ครับ/ค่ะ ซึ่งจะทำให้คุณลูกค้ายังได้รับความคุ้มครองในกรณีเจ็บป่วยหนักอยู่ **แผนนี้จะช่วยคุณลูกค้าประหยัดได้มากครับ/ค่ะ**" },
    { id: "P3Q12", part: 3, q: "ฉันไม่มีงบประมาณสำหรับสิ่งนี้ในตอนนี้", a: "แผนนี้ถูกออกแบบมาเพื่อ **ป้องกันไม่ให้คุณลูกค้าต้องใช้เงินก้อนใหญ่** ในอนาคตครับ/ค่ะ โดยเบี้ยประกันเพียง [ระบุจำนวนเงิน] ต่อเดือน ซึ่งถือเป็นการ **ลงทุนเพื่อปกป้องเงินเก็บ** ที่คุ้มค่าที่สุดครับ/ค่ะ" },
    { id: "P3Q13", part: 3, q: "ฉันต้องใช้เงินส่วนนี้ไปกับอย่างอื่นที่สำคัญกว่า", a: "นั่นเป็นเรื่องจริงครับ/ค่ะ แต่จะมีอะไรสำคัญไปกว่า **ความมั่นคงทางสุขภาพ** และการป้องกันไม่ให้เงินเก็บทั้งหมดต้องหายไปกับค่ารักษาพยาบาลฉุกเฉินครับ/ค่ะ? **แผนนี้เป็นการจัดลำดับความสำคัญของความเสี่ยงครับ/ค่ะ**" },
    { id: "P3Q14", part: 3, q: "ฉันไม่แน่ใจว่าจะสามารถจ่ายเบี้ยได้ตลอดรอดฝั่งไหม", a: "บริษัทเราเข้าใจถึงความไม่แน่นอนครับ/ค่ะ เรามีแผนที่อนุญาตให้คุณลูกค้า **หยุดพักชำระเบี้ย (Premium Holiday)** ได้ในกรณีฉุกเฉินทางการเงิน โดยยังคงรักษาสถานะความคุ้มครองไว้ได้ระยะหนึ่งครับ/ค่ะ" },
    { id: "P3Q15", part: 3, q: "บริษัทอื่นเสนอความคุ้มครองใกล้เคียงกัน แต่เบี้ยถูกกว่า", a: "อาจเป็นจริงครับ/ค่ะ แต่รบกวนคุณลูกค้าตรวจสอบ **วงเงินสูงสุดต่อปี/ต่อครั้ง** และ **เครือข่ายโรงพยาบาล** รวมถึง **บริการเสริมพิเศษ** ที่เรามีให้ครับ/ค่ะ บ่อยครั้งที่เบี้ยถูกกว่าแลกมากับ **ข้อจำกัดที่มองไม่เห็น** ครับ/ค่ะ" },
    { id: "P3Q16", part: 3, q: "ฉันไม่แน่ใจว่ามัน **คุ้มค่า** กับเงินที่จ่ายไปจริง ๆ ไหม", a: "ถ้าอย่างนั้น ขออนุญาตให้คุณลูกค้าลองจินตนาการถึง **มูลค่าความคุ้มครอง [ระบุวงเงินสูงสุด]** ที่คุณลูกค้าจะได้รับเทียบกับ **เบี้ย [ระบุจำนวนเงิน]** ต่อปี หากเกิดเจ็บป่วยหนักขึ้นมา นี่คือสิ่งที่เรียกว่าความคุ้มค่าสูงสุดครับ/ค่ะ" },
    { id: "P3Q17", part: 3, q: "ฉันไม่มั่นใจใน **ความมั่นคง** ของบริษัทประกันของคุณ", a: "บริษัทเรา [ระบุชื่อบริษัท] ก่อตั้งมา [ระบุจำนวนปี] และมี **อัตราส่วนเงินกองทุนที่สูง** มากครับ/ค่ะ **เรามีอันดับความน่าเชื่อถือระดับสากล** ซึ่งยืนยันความมั่นคงของเราในการจ่ายสินไหมทดแทนได้ 100% ครับ/ค่ะ" },
    { id: "P3Q18", part: 3, q: "ประสบการณ์จากคนรอบตัวบอกว่าประกันสุขภาพ **เคลมยาก**", a: "ดิฉัน/ผมเข้าใจความกังวลครับ/ค่ะ แต่ปัญหาส่วนใหญ่เกิดจาก **การไม่เข้าใจเงื่อนไขก่อนทำสัญญา** หรือ **การไม่แถลงสุขภาพที่เป็นจริง** ตั้งแต่แรกครับ/ค่ะ แผนของเรามี **ระบบเคลมแบบไม่ต้องสำรองจ่าย** ที่รวดเร็ว และผม/ดิฉันจะช่วยตรวจสอบเงื่อนไขทั้งหมดก่อนการสมัครครับ/ค่ะ" },
    { id: "P3Q19", part: 3, q: "ฉันเคยมีประสบการณ์ที่ไม่ดีกับการซื้อประกันทางโทรศัพท์", a: "ดิฉัน/ผมขออภัยแทนบริษัทอื่น ๆ ด้วยครับ/ค่ะ บริษัทเรามี **การบันทึกเสียงและขั้นตอนการตรวจสอบคุณภาพ** ที่เข้มงวดมากครับ/ค่ะ และมี **ระยะเวลา Free Look 15 วัน** ให้คุณลูกค้าทบทวนและยกเลิกได้เต็มจำนวนหากไม่พอใจครับ/ค่ะ" },
    { id: "P3Q20", part: 3, q: "ถ้าฉันยังสุขภาพดีอยู่ ไม่จำเป็นต้องทำตอนนี้ก็ได้นี่?", a: "การทำประกันตอนที่ **สุขภาพดีที่สุด** คือช่วงเวลาที่ **ดีที่สุด** ครับ/ค่ะ เพราะคุณลูกค้าจะ **ได้รับการคุ้มครองครบถ้วน 100%** และ **เบี้ยถูกที่สุด** หากรอจนสุขภาพเปลี่ยนไป อาจทำให้ถูกปฏิเสธหรือถูกเพิ่มเบี้ยได้ครับ/ค่ะ" },
    { id: "P3Q21", part: 3, q: "ฉันไม่อยากให้ **ข้อมูลส่วนตัว** และเลขบัญชีทางโทรศัพท์", a: "เราเข้าใจเรื่องความเป็นส่วนตัวครับ/ค่ะ ข้อมูลทั้งหมดถูกจัดการอย่างปลอดภัยภายใต้ **นโยบายความเป็นส่วนตัวและ พ.ร.บ. คุ้มครองข้อมูลส่วนบุคคล** ข้อมูลบัญชีใช้เพื่อ **หักเบี้ยประกันเท่านั้น** โดยไม่มีใครเข้าถึงข้อมูลอื่นได้ครับ/ค่ะ" },
    { id: "P3Q22", part: 3, q: "ฉันไม่มี **บัตรเครดิต** หรือ **สมุดบัญชี** อยู่กับตัวตอนนี้", a: "ไม่เป็นไรครับ/ค่ะ ดิฉัน/ผมสามารถบันทึกข้อมูลเพื่อ **สำรองสิทธิ์** ไว้ก่อนได้ และคุณลูกค้าสามารถ **ส่งข้อมูลการชำระเงิน** มาให้ดิฉัน/ผมทางช่องทางที่ปลอดภัย ภายในวันนี้ได้ไหมครับ/ค่ะ? (เพื่อรักษาสิทธิ์)" },
    { id: "P3Q23", part: 3, q: "ฉันไม่สะดวก **รับสายยืนยัน** จากฝ่ายตรวจสอบคุณภาพ", a: "สายยืนยันเป็นขั้นตอนสำคัญเพื่อ **ยืนยันว่าคุณลูกค้าเข้าใจและยินยอม** ทุกเงื่อนไขครับ/ค่ะ โดยใช้เวลาเพียง 3-5 นาทีเท่านั้น **ขออนุญาตโทรกลับไป [ระบุเวลาที่ลูกค้าสะดวกที่สุด เช่น หลังเลิกงาน]** เพื่อให้การสมัครสมบูรณ์นะครับ/คะ" },
    { id: "P3Q24", part: 3, q: "เอกสารมันเยอะและซับซ้อนเกินไป ฉันขี้เกียจอ่าน", a: "ดิฉัน/ผมได้ **ทำเครื่องหมาย** ในส่วนที่สำคัญที่สุดสำหรับคุณลูกค้าไว้แล้วครับ/ค่ะ ส่วนรายละเอียดปลีกย่อยเป็นข้อกำหนดทางกฎหมาย **คุณลูกค้าเพียงแค่ทบทวนส่วนที่ดิฉัน/ผมเน้นย้ำ** ก็เพียงพอต่อการตัดสินใจแล้วครับ/ค่ะ" },
    { id: "P3Q25", part: 3, q: "ฉันต้องการ **นัดพบตัวแทน** เพื่อเซ็นเอกสารจริง", a: "การนัดพบตัวแทนอาจทำให้ **ขั้นตอนล่าช้า** และ **สิทธิ์พิเศษนี้หมดลง** ได้ครับ/ค่ะ การทำรายการทางโทรศัพท์นี้ถูกต้องตามกฎหมายและ **รวดเร็วกว่า** เพื่อให้คุณลูกค้าได้รับความคุ้มครองทันทีครับ/ค่ะ" },
    { id: "P3Q26", part: 3, q: "ฉันไม่ใช่ผู้มีอำนาจตัดสินใจเรื่องค่าใช้จ่ายขนาดนี้", a: "ถ้าเช่นนั้น ขออนุญาตติดต่อ **ผู้มีอำนาจตัดสินใจโดยตรง** ได้ไหมครับ/ค่ะ หรือดิฉัน/ผมสามารถส่ง **สรุปผลประโยชน์สั้น ๆ** ไปให้คุณลูกค้านำเสนอเพื่อขออนุมัติได้เลยครับ/ค่ะ" },
    { id: "P3Q27", part: 3, q: "ฉันจะซื้อเมื่อพร้อมเท่านั้น **อย่าเร่ง**", a: "ดิฉัน/ผมไม่ได้เร่งคุณลูกค้าครับ/ค่ะ เพียงแต่ดิฉัน/ผมมีหน้าที่แจ้งว่า **โอกาสในการได้สิทธิ์เบี้ยนี้จะหมดลงใน [ระบุเวลา/วันนี้]** ครับ/ค่ะ การจองสิทธิ์ไว้ก่อนจะช่วยให้คุณลูกค้าซื้อเมื่อพร้อมในราคาที่ดีที่สุดครับ/ค่ะ" },
    { id: "P3Q28", part: 3, q: "คุณพูดเร็วไป ฉันตามไม่ทัน (ข้ออ้างในการชะลอ)", a: "ขออภัยครับ/ค่ะ ดิฉัน/ผมจะพูดให้ช้าลงนะครับ/คะ **มีส่วนไหนที่คุณลูกค้าต้องการให้ทวน** หรือให้ **ดิฉัน/ผมเน้นย้ำเป็นพิเศษ** ไหมครับ/คะ? (เน้นย้ำประโยชน์หลักอีกครั้งอย่างช้าๆ)" },
    { id: "P3Q29", part: 3, q: "แผนนี้มัน **ยุ่งยาก/ซับซ้อน** เกินความจำเป็นของฉัน", a: "ดิฉัน/ผมเข้าใจครับ/ค่ะ หากต้องการความง่ายกว่านี้ **เรามีแผนที่เรียบง่ายกว่า** ซึ่งเน้นเฉพาะ [ระบุจุดคุ้มครองสำคัญ] และ **เบี้ยเริ่มต้น [ระบุจำนวนเงิน]** โดยตัดฟีเจอร์ที่ไม่จำเป็นออกไปครับ/ค่ะ สนใจแผนนี้ไหมครับ/คะ?" },
    { id: "P3Q30", part: 3, q: "ฉันไม่เชื่อในคำว่า **'สิทธิ์พิเศษมีจำนวนจำกัด'** ของคุณ", a: "เข้าใจครับ/ค่ะ คำว่า 'จำกัด' นี้หมายถึง **โควต้าเบี้ยพิเศษ** ที่บริษัทจัดสรรให้ลูกค้ากลุ่มนี้โดยเฉพาะ **ซึ่งหมดลงตามรอบทุก ๆ [ระบุช่วงเวลา เช่น สิ้นเดือน]** หากเกินช่วงนี้ คุณลูกค้าจะต้องทำในราคาปกติครับ/ค่ะ **การันตีด้วยการแจ้งเตือนจากระบบของเราครับ/ค่ะ**" }
]
        };


        // --- Global Variables ---
        // audioBlobs เก็บ Object ที่มี { blob, submitted: boolean }
        let audioBlobs = { part1: {}, part2: {}, part3: {} }; 
        let mediaRecorder;
        let audioChunks = [];
        let currentPart = 'part1'; 
        let shuffledQuestions = []; 
        let currentIndex = 0;

        const inputUserName = document.getElementById('inputUserName');
        const mainAlert = document.getElementById('mainAlert');
        const recordingStatus = document.getElementById('recordingStatus');
        const startRecBtn = document.getElementById('startRecBtn');
        const stopRecBtn = document.getElementById('stopRecBtn');
        const playbackAudio = document.getElementById('playbackAudio');
        const questionList = document.getElementById('questionList');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const submitBtn = document.getElementById('submitBtn'); // ปุ่มส่งงานรวม (ตรวจสอบ)
        const questionPrompt = document.getElementById('questionPrompt');
        const requiredAnswer = document.getElementById('requiredAnswer');
        const sendQuestionBtn = document.getElementById('sendQuestionBtn'); // ปุ่มส่งคำตอบทีละข้อ


        // --- Helper Functions ---

        function showAlert(message, type = 'info') {
            mainAlert.innerHTML = message;
            mainAlert.className = `alert ${type}`;
            mainAlert.style.display = 'block';
            setTimeout(() => {
                mainAlert.style.display = 'none';
            }, 5000);
        }

        window.saveUserName = function() {
            localStorage.setItem('examUserName', inputUserName.value.trim());
            checkSubmitButtonStatus();
        }

        // --- Supabase Core Functions (Logic Unchanged) ---

        /**
         * @description อัปโหลดไฟล์เสียงไปยัง Supabase Storage ด้วยโครงสร้าง Path ที่ถูกต้อง
         */
        async function uploadAudioToSupabase(fileBlob, questionId, partKey, userName) {
            const partNum = partKey.replace('part', 'P');
            const safeUserName = userName.replace(/[^a-zA-Z0-9ก-ฮเ-์]/g, '_');
            const fileName = `${safeUserName}_${partNum}_${questionId}_${Date.now()}.webm`;
            
            // Path: responses/part1/P1Q1/ชื่อไฟล์.webm
            const filePath = `${partKey}/${questionId}/${fileName}`; 
            
            const audioFile = new File([fileBlob], fileName, { type: fileBlob.type });

            console.log(`Uploading file to: ${filePath}`);

            const { error } = await supabase.storage
                .from('responses')
                .upload(filePath, audioFile, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error(`Upload error for ${questionId}:`, error.message);
                throw new Error(`Upload failed for ${questionId}: ${error.message}`);
            }

            const { data: { publicUrl } } = supabase.storage
                .from('responses')
                .getPublicUrl(filePath);

            console.log(`Uploaded file URL for ${questionId}: ${publicUrl}`);
            return publicUrl;
        }

        /**
         * @description อัปโหลดและส่งข้อมูลคำตอบสำหรับคำถามเดียวไปยัง Supabase
         */
        async function submitSingleResponse(blob, question, userName, partKey) {
            const questionId = question.id;

            // 1. อัปโหลดไฟล์
            const publicUrl = await uploadAudioToSupabase(blob, questionId, partKey, userName);

            // 2. เตรียมข้อมูลเพื่อ Insert เข้าตาราง 'voice_answers'
            const questionNumber = parseInt(questionId.replace(/[a-zA-Z]+/, ''));
            if (isNaN(questionNumber)) {
                throw new Error(`Invalid question ID format: ${questionId}`);
            }

            const responseToInsert = {
                user_id: userName, 
                exam_id: userName, 
                part: partKey, 
                question_number: questionNumber, 
                audio_url: publicUrl, 
                created_at: new Date().toISOString()
            };
            
            // 3. Insert เข้าตาราง 'voice_answers'
            const { error: insertError } = await supabase
                .from('voice_answers')
                .insert([responseToInsert]);

            if (insertError) {
                console.error('Database insert error (voice_answers):', insertError.message);
                throw new Error(`Database submission failed: ${insertError.message}`);
            }
            
            return questionNumber;
        }


        // --- UI and Navigation Functions (Logic Unchanged) ---
                
        function renderQuestionList() {
            questionList.innerHTML = '';
            shuffledQuestions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'question-item';
                item.id = `q-item-${index}`;
                // ใช้ window.displayQuestionFromList เพื่อให้เรียกจาก HTML ได้
                item.setAttribute('onclick', `displayQuestionFromList(${index})`); 
                
                const status = audioBlobs[currentPart][q.id];
                let statusIcon = '';
                let color = 'red';

                if (status) {
                    if (status.submitted) {
                        // สถานะ: ส่งสำเร็จ
                        statusIcon = '✓';
                        color = 'green';
                    } else {
                        // สถานะ: บันทึกแล้ว แต่ยังไม่ส่ง (รอตรวจสอบ)
                        statusIcon = '•';
                        color = 'orange';
                    }
                } else {
                    // สถานะ: ยังไม่บันทึก
                    statusIcon = '•';
                    color = 'red';
                }

                item.innerHTML = `ข้อที่ ${index + 1} <span class="status-icon" style="color: ${color};">${statusIcon}</span>`;
                
                if (index === currentIndex) {
                    item.classList.add('active');
                }
                
                questionList.appendChild(item);
            });
            // ตรวจสอบสถานะปุ่มส่งงานรวมทุกครั้งที่อัปเดตรายการ
            checkSubmitButtonStatus(); 
        }

        function updateQuestionUI(question) {
            document.getElementById('currentQuestionTitle').textContent = `Part ${question.part}: คำถามข้อที่ ${currentIndex + 1}`;
            
            questionPrompt.textContent = question.q; 
            requiredAnswer.innerHTML = question.a;
            
            // ตั้งค่าสถานะปุ่มและเสียง
            const status = audioBlobs[currentPart][question.id];
            playbackAudio.style.display = 'none';
            sendQuestionBtn.style.display = 'none';
            sendQuestionBtn.disabled = true;

            if (status) {
                const blob = status.blob;
                playbackAudio.src = URL.createObjectURL(blob);
                playbackAudio.style.display = 'block';

                if (status.submitted) {
                    // บันทึกและส่งสำเร็จแล้ว
                    recordingStatus.textContent = 'สถานะ: ส่งข้อมูลสำเร็จแล้ว (สามารถฟังหรือบันทึกใหม่เพื่อส่งซ้ำได้)';
                    sendQuestionBtn.textContent = 'บันทึกใหม่และส่งซ้ำ';
                    sendQuestionBtn.style.display = 'block';
                    sendQuestionBtn.disabled = false;
                } else {
                    // บันทึกแล้ว แต่ยังไม่ส่ง (รอการตรวจสอบ)
                    recordingStatus.textContent = 'สถานะ: บันทึกสำเร็จแล้ว! กรุณาฟังและกด "ส่งคำตอบข้อนี้"';
                    sendQuestionBtn.textContent = 'ส่งคำตอบข้อนี้ (บันทึกและส่ง)';
                    sendQuestionBtn.style.display = 'block';
                    sendQuestionBtn.disabled = false;
                }
            } else {
                // ยังไม่ได้บันทึก
                playbackAudio.src = '';
                recordingStatus.textContent = 'สถานะ: ยังไม่ได้เริ่มบันทึกเสียง';
                sendQuestionBtn.style.display = 'none';
            }
            
            startRecBtn.disabled = false;
            stopRecBtn.disabled = true;
            
            renderQuestionList();
        }

        function displayQuestion(index) {
            currentIndex = index;
            const question = shuffledQuestions[index];
            
            updateQuestionUI(question);
        }

        window.displayQuestionFromList = function(index) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                if (!confirm('กรุณาหยุดบันทึกเสียงก่อนเปลี่ยนไปทำข้ออื่น')) {
                    return;
                }
                // ถ้ามีการบันทึกอยู่ ให้หยุดและบันทึกใน cache ก่อนเปลี่ยนข้อ
                if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    // mediaRecorder.onstop จะทำงานต่อ
                }
            }
            displayQuestion(index);
        };

        window.loadPart = function(partKey) {
            if (!inputUserName.value.trim()) {
                showAlert('กรุณากรอกชื่อ-นามสกุล/รหัสพนักงานก่อนเลือก Part', 'warning');
                return;
            }
            saveUserName();
            
            currentPart = partKey;
            currentIndex = 0;
            
            const allQuestions = questions[currentPart];
            shuffledQuestions = allQuestions; // ใช้คำถามทั้งหมดตามลำดับ
            
            document.getElementById('examArea').style.display = 'grid';
            
            document.querySelectorAll('.part-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn${partKey.charAt(0).toUpperCase() + partKey.slice(1)}`).classList.add('active');

            displayQuestion(currentIndex);
        };

        // --- Submission Control (Logic Unchanged) ---

        window.handleSingleSubmission = async function() {
            const question = shuffledQuestions[currentIndex];
            const questionId = question.id;
            const userName = inputUserName.value.trim();
            const status = audioBlobs[currentPart][questionId];
            
            if (!status || !status.blob) {
                showAlert('ไม่พบไฟล์เสียงที่บันทึกไว้สำหรับข้อนี้ กรุณาบันทึกใหม่', 'warning');
                return;
            }

            const audioBlob = status.blob;

            // UI: เริ่มต้นการส่งข้อมูล
            loadingOverlay.style.display = 'flex';
            recordingStatus.textContent = 'สถานะ: กำลังอัปโหลดและส่งข้อมูล...';
            sendQuestionBtn.disabled = true;

            try {
                // 💡 เรียกฟังก์ชันส่งข้อมูลแบบเดี่ยว
                const questionNum = await submitSingleResponse(audioBlob, question, userName, currentPart);
                
                // 1. Success UI & Update Cache
                loadingOverlay.style.display = 'none';
                
                // อัปเดตสถานะใน cache เป็น submitted: true
                audioBlobs[currentPart][questionId].submitted = true; 

                recordingStatus.textContent = 'สถานะ: ส่งข้อมูลสำเร็จแล้ว!';
                showAlert(`ส่ง Part ${currentPart.replace('part', '')} ข้อที่ ${questionNum} สำเร็จแล้ว!`, 'success');

            } catch (error) {
                // 2. Error UI
                loadingOverlay.style.display = 'none';
                console.error('Submission Error:', error);
                
                // อัปเดตสถานะใน cache เป็น submitted: false
                if (audioBlobs[currentPart][questionId]) {
                    audioBlobs[currentPart][questionId].submitted = false; 
                }

                recordingStatus.textContent = 'สถานะ: เกิดข้อผิดพลาดในการส่งข้อมูล! กรุณากด "ส่งคำตอบข้อนี้" อีกครั้ง';
                showAlert(`ส่งข้อมูลล้มเหลว: ${error.message}`, 'warning');

            } finally {
                // อัปเดต UI ไม่ว่าจะสำเร็จหรือล้มเหลว
                updateQuestionUI(question);
            }
        };


        // --- Recording Functions (Logic Unchanged) ---

        window.handleStartRecording = async function() {
            if (!inputUserName.value.trim()) {
                showAlert('กรุณากรอกชื่อ-นามสกุล/รหัสพนักงานก่อนเริ่มบันทึก', 'warning');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                // 💡 mediaRecorder.onstop จะทำแค่บันทึก Blob ลง Cache และอัปเดต UI
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];
                    
                    const question = shuffledQuestions[currentIndex];
                    const questionId = question.id;
                    
                    // 1. บันทึก Blob ไว้ใน Cache (สถานะ submitted: false)
                    audioBlobs[currentPart][questionId] = { 
                        blob: audioBlob, 
                        submitted: false 
                    }; 

                    // 2. ต้องหยุด Track ของ Stream เพื่อปล่อยการใช้ไมโครโฟน
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    updateQuestionUI(question); // อัปเดต UI เพื่อแสดงปุ่ม "ส่งคำตอบข้อนี้"
                    showAlert('บันทึกเสียงสำเร็จแล้ว! กรุณาตรวจสอบแล้วกด "ส่งคำตอบข้อนี้"', 'info');
                };

                mediaRecorder.onstart = () => {
                    recordingStatus.textContent = 'สถานะ: กำลังบันทึกเสียง...';
                    startRecBtn.disabled = true;
                    stopRecBtn.disabled = false;
                    playbackAudio.style.display = 'none';
                    sendQuestionBtn.style.display = 'none';
                    playbackAudio.src = '';
                };

                mediaRecorder.start();

            } catch (err) {
                console.error('Recording failed:', err);
                showAlert('ไม่สามารถเข้าถึงไมโครโฟนได้: ' + err.message, 'warning');
            }
        };

        window.handleStopRecording = function() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                // mediaRecorder.onstop จะทำงานต่อเพื่อบันทึก Blob
            }
        };

        // --- Submission & Upload (Final) (Logic Unchanged) ---

        function checkSubmitButtonStatus() {
            const totalQuestions = shuffledQuestions.length;
            // นับเฉพาะข้อที่มีสถานะ submitted: true
            const submittedCount = Object.values(audioBlobs[currentPart]).filter(s => s.submitted).length;

            submitBtn.textContent = `ส่งงาน Part ${currentPart.replace('part', '')} (ส่งแล้ว ${submittedCount}/${totalQuestions} ข้อ)`;

            // 💡 เงื่อนไขที่แก้ไข: ปุ่มจะถูกเปิดใช้งานหากมีการส่งข้อมูลสำเร็จอย่างน้อย 1 ข้อ
            if (submittedCount > 0) { 
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        window.submitExam = function() {
            const totalQuestions = shuffledQuestions.length;
            const submittedCount = Object.values(audioBlobs[currentPart]).filter(s => s.submitted).length;

            if (totalQuestions > 0 && submittedCount === totalQuestions) {
                showAlert(`Part ${currentPart.replace('part', '')} ส่งข้อมูลครบถ้วน ${submittedCount}/${totalQuestions} ข้อแล้ว! คุณสามารถเลือก Part อื่นเพื่อทำแบบทดสอบต่อได้เลย`, 'success');
            
                // ตั้งค่าหน้าจอเป็นหน้าเลือก Part ใหม่
                document.getElementById('examArea').style.display = 'none';
                document.getElementById('currentQuestionTitle').textContent = 'ส่งงานสำเร็จ';
                document.getElementById('questionPrompt').textContent = 'กรุณาเลือก Part อื่นเพื่อทำแบบทดสอบต่อ';
                document.getElementById('requiredAnswer').textContent = '';
                
            } else if (submittedCount > 0) {
                // กรณีที่เปิดปุ่มแล้ว แต่ยังส่งไม่ครบ 30 ข้อ: แสดงคำเตือน
                showAlert(`**คุณได้ส่งไปแล้ว ${submittedCount} ข้อ** แต่ยังมีคำตอบ ${totalQuestions - submittedCount} ข้อใน Part นี้ที่ยังไม่ได้ถูกส่ง กรุณาตรวจสอบและกด "ส่งคำตอบข้อนี้" ในแต่ละข้อให้ครบถ้วนก่อน`, 'warning');
            } else {
                 // กรณีที่ยังไม่มีการส่งไฟล์สำเร็จเลย
                showAlert(`ยังไม่มีการส่งไฟล์เสียงสำเร็จเลย กรุณาส่งอย่างน้อย 1 ข้อก่อน`, 'warning');
            }
        };


        // --- Initialization ---

        const storedUserName = localStorage.getItem('examUserName');
        if (storedUserName) {
            inputUserName.value = storedUserName;
        }

        // ตรวจสอบสถานะปุ่มส่งเมื่อโหลดหน้าเว็บ
        checkSubmitButtonStatus();

    </script>

</body>
</html>
